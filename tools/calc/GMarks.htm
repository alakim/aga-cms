<html>
<head>
	<script type="text/javascript" src="../_js/jxml.js"></script>
	<script type="text/javascript">
		function $(id){return document.getElementById(id);}
		
		function importBookmarks(){
			var dom = $("gmarks").contentDocument.body;
			var doc = JXML.fromDom(dom, {allowAttributes:/href/i});
			
			$("tbSrc").value = doc.toString(true);
			var res = buildDoc(doc);
			$("tbJXml").value = res.toString(true);
			$("tbRes").value = res.getJXmlCode();
		}
		
		function normalize(str){
			return str.replace(/\"/g, "\\\"").replace(/\'/g, "\\\'").replace(/[\n\r]/g, " ");
		}
		
		function buildDoc(doc){
			var index = {};
			var links = doc.$root().selectNodes("//a");
			for(var i=0;i<links.length;i++){var lnk = links[i];
				var href = lnk.attributes.href.value;
				var dsc = lnk.selectSingleNode("ancestor::dt").selectSingleNode("following-sibling::*");
				if(dsc && dsc.tagName!="dd")
					dsc = null;
				var iL = index[href];
				if(!iL){
					iL = {href:href, label:normalize(lnk.childNodes[0].value), tags:{}};
					if(dsc)
						iL.dsc = normalize(dsc.childNodes[0].value);
					index[href] = iL;
				}
				var tag = lnk.selectSingleNode("ancestor::dl").selectSingleNode("preceding-sibling::h3[1]").childNodes[0].value;
				iL.tags[tag] = true;
			}
			
			var res = ["bookmarks", []];
			for(var k in index){
				var lnk = index[k];
				var ndL = ["link", {href:k, label:lnk.label}, []];
				if(lnk.dsc)
					ndL[1].dsc = lnk.dsc;
				for(var t in lnk.tags){
					if(t!="Без ярлыка")
						ndL[2].push(["tag", {nm:t}]);
				}
				res[1].push(ndL);
			}
			
			return new JXML.JXmlElement(res);
		}
		
	</script>
</head>
<body>
	<iframe id="gmarks" src="gmarks/GoogleBookmarks.html"></iframe>
	<textarea id="tbRes" style="width:300px; height:150px;"></textarea>
	<br>
	<button onclick="importBookmarks()">Import</button>
	<br>
	<textarea id="tbJXml" style="width:100%; height:250px;"></textarea>
	<br>
	<textarea id="tbSrc" style="width:100%; height:250px;"></textarea>
</body>
</html>